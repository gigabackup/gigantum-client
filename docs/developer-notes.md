gtm developer notes
===================

general gotchas
---------------

If the gigantum direcotry doesn't exist on Linux, the docker daemon will create
it on mount and it will be owned by root - thus unreadable. You can create your
gigantum directory by hand, or by using one of the more user-friendly gigantum
tools first.

Configuration and other resources
---------------------------------

Each command for gtm.py is implemented in an independent module in gtmlib (e.g.,
`developer` or `labmanager`). Similarly, there are separate resource directories
that are used for each command (e.g., `gtmlib/resources/developer_resources` and
`gtmlib/resources/labmanager_resources`).

The *-config.yaml files in these directories are auto-generated by the build
process. Therefore, there are corresponding `*-config-override.yaml` files that
allow the developer to control the contents of these files. For an example, see
the section below for "Publishing" under "base images".

base images
-----------

Base images are defined and built using descriptions in the `base-images`
submodule. The format is fairly transparent, and the easiest approach for now
is to duplicate an existing YAML file.

EVEN IF the base image is available locally, the app will look for a manifest
on Docker Hub, so you need to publish (for now) even for testing.

Inspecting Redis
----------------

For some tasks, it is useful to inspect the Redis database. By default, it is
not exposed to the host, but this is easy to add in 
`build/developer/docker-compose.yml`. Simply add `"6379:6379"` in the list under 
`ports:`. This file is generated by `gtm dev setup` and not tracked by Git, so no
extra caution is required.

On subsequent runs of the dev API, you can now inpsect Redis directly from the host.
A nice tool is `redis-commander`, which can be run directly with `npx redis-commander`
(assuming you have a recent npm install).

### Publishing

To use `base-image publish`, you need to be logged in to docker hub (can be
done from the command line with `docker login` or via the Docker for Win/Mac
GUI).  Unfortunately, Docker credentials are stored unencrypted on Linux:

    WARNING! Your password will be stored unencrypted in /home/dav/.docker/config.json.
    Configure a credential helper to remove this warning. See
    https://docs.docker.com/engine/reference/commandline/login/#credentials-store

Currently, the secretstore tar.gz packages are malformed, so just be careful?

### Informing the app

You don't have to use the app to update the base image. You can directly edit
`.gigantum/env/base/gigantum_environemtn_<labbook-name>.yaml` in the labbook's
directory.

For the UI to make an image avilable, you need to update the
environment-components repo,Â and if you are developing in a branch you can
specify that in `gtmlib/resources/developer_resources/labmanager-config-overrides.yaml` 
like so:

    environment:
      repo_url:
        - "https://github.com/gigantum/environment-components.git@<branch-name>"

The app will automatically update to this branch at launch (it's stored in the
.labmanager directory under your gigantum directory).

Other useful tools
------------------

For a GUI to clean up your Docker context, the easiest tool is portainer, which can 
itself be run via Docker. See their website for up-to-date instructions for use, or just run:

    docker run --rm -d -p 9000:9000 -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data portainer/portainer
